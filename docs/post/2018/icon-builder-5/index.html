<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Icon Builder 5 :: TrozWare</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="" />
<meta name="keywords" content="[Swift Apple macOS iOS Apple Watch]" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://troz.net/post/2018/icon-builder-5/" />


<link rel="stylesheet" href="/assets/style.css">
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="/assets/style.css">




<link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">



    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@trozware" />
    <meta name="twitter:title" content="Icon Builder" />
    <meta name="twitter:description" content="Updating a Mac app - what, why, how..." />
    <meta name="twitter:url" content="https://troz.net/post/2018/icon-builder-5/" />
    <meta name="twitter:image" content="https://troz.net/icons/IconBuilder128.png" />






<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Icon Builder 5 :: TrozWare — ">
<meta property="og:description" content="" />
<meta property="og:url" content="https://troz.net/post/2018/icon-builder-5/" />
<meta property="og:site_name" content="Icon Builder 5" />
<meta property="og:image" content="https://troz.net/img/default.jpg">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


<meta property="article:published_time" content="2018-02-18 10:19:18 &#43;1000 AEST" />






</head>
<body class="dark-theme">
<div class="container">
  <header class="header">
  <span class="header__inner">
    <a href="https://troz.net/" style="text-decoration: none;">
  <div class="logo">
    
      <span class="logo__mark">></span>
      <span class="logo__text">TrozWare</span>
      <span class="logo__cursor"></span>
    
  </div>
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner">
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/apps/">Apps</a></li>
    
      <li><a href="/post/">Archives</a></li>
    
      <li><a href="/tags/">Tags</a></li>
    
      <li><a href="/contact/">Contact</a></li>
    
  </ul>
</nav>
        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>        
        </span>
      
      <span class="theme-toggle">
        <svg class="bulb-off" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="24" height="24"/>
  <path d="M4 19C4 19.55 4.45 20 5 20H9C9.55 20 10 19.55 10 19V18H4V19ZM7 0C3.14 0 0 3.14 0 7C0 9.38 1.19 11.47 3 12.74V15C3 15.55 3.45 16 4 16H10C10.55 16 11 15.55 11 15V12.74C12.81 11.47 14 9.38 14 7C14 3.14 10.86 0 7 0ZM9.85 11.1L9 11.7V14H5V11.7L4.15 11.1C2.8 10.16 2 8.63 2 7C2 4.24 4.24 2 7 2C9.76 2 12 4.24 12 7C12 8.63 11.2 10.16 9.85 11.1Z" transform="translate(5 2)" fill="black"/>
</svg>

<svg class="bulb-on" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="24" height="24"/>
  <path class="bulb-on__base" d="M4 19C4 19.55 4.45 20 5 20H9C9.55 20 10 19.55 10 19V18H4V19Z" transform="translate(5 2)" fill="#a9a9b3" />
  <path class="bulb-on__glass" d="M0 7C0 3.14 3.14 0 7 0C10.86 0 14 3.14 14 7C14 9.38 12.81 11.47 11 12.74V15C11 15.55 10.55 16 10 16H4C3.45 16 3 15.55 3 15V12.74C1.19 11.47 0 9.38 0 7Z" transform="translate(5 2)" fill="#a9a9b3" />
</svg>
  
      </span>
    </span>
  </span>
</header>


  <div class="content">
    
<div class="post">
  <h2 class="post-title"><a href="https://troz.net/post/2018/icon-builder-5/">Icon Builder 5</a></h2>
  <div class="post-meta">
    <span class="post-date">
      18 Feb 2018
    </span>
    <span class="more-meta"> 1181 words, </span>
    <span class="more-meta"> 6 minute read</span>
  </div>

  
  <span class="post-tags">
    
    #<a href="https://troz.net/tags/icons">icons</a>&nbsp;
    
    #<a href="https://troz.net/tags/mac">mac</a>&nbsp;
    
    #<a href="https://troz.net/tags/ios">ios</a>&nbsp;
    
    #<a href="https://troz.net/tags/watch">watch</a>&nbsp;
    
    #<a href="https://troz.net/tags/apple-watch">apple watch</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    <p><a href="/icon-builder/">Icon Builder 5.0</a> is now available from the <a href="http://itunes.apple.com/app/icon-builder/id552293482">Mac App Store</a>. This is a complete re-write for better compatibility with Apple&rsquo;s latest icon requirements. Read on to see what I have fixed and how&hellip;</p>

<p></p>

<hr />

<h2 id="problems">Problems</h2>

<p>When I came to create a new iOS app recently, I found out that Icon Builder had fallen behind Apple&rsquo;s requirements in three ways:</p>

<ol>
<li>The 1024 x 1024 marketing icon is now supposed to be inside the app&rsquo;s icon set.</li>
<li>Icon files must have their color profile set to sRGB (P3 is also valid for iOS apps).</li>
<li>iOS icon files must have no transparent pixels and the alpha channel must be removed from the files.</li>
</ol>

<p>When I set to work fixing these problems I soon ran into issues with the existing version of Icon Builder which was created 6 years ago.</p>

<ul>
<li>It was written in Objective-C which I am increasingly finding difficult and un-safe to write.</li>
<li>The app was written when I was very much a beginner in Mac apps and this is obvious from the code&hellip;</li>
<li>There was a lot of legacy code left over from previous changes and extensions.</li>
</ul>

<p>So I decided that the most interesting thing to do would be to start almost from scratch and re-write the app in Swift using better techniques.</p>

<h2 id="the-re-write">The Re-write</h2>

<p>Now instead of the Massive View Controller, I have a larger set of small files, each with their own responsibility. Enums and structs dictate the various requirements for the different devices or app types. Other structs deal with creating the images, the folder management and writing out the files. An NSImage extension handles the resizing and reformatting of the images. This is now an app that I would not be ashamed to show anyone, except perhaps for the need to add more unit tests.</p>

<h2 id="adding-a-color-profile">Adding a color profile</h2>

<p>But then we get to the new features needed. Adding the 1024x1024 icon to the app icon set was easy, especially after the re-factoring. But what about the color profile?</p>

<p>This was not as easy as I expected - there is no built in command to apply a profile but here is the solution that I finally found:</p>

<pre><code class="language-swift">extension NSImage {

  func convertImageTo_sRGB() throws -&gt; Data {
      guard let colorSpace = CGColorSpace(name: CGColorSpace.sRGB),
          let cgi = self.cgImage(forProposedRect: nil,
                                 context: nil,
                                 hints: nil) else {
                                  throw ImageError.cantMakeCgImage
      }

      let ci = CIImage(cgImage: cgi)

      guard let pngData = CIContext().pngRepresentation(of: ci,
                                                        format: kCIFormatRGBA8,
                                                        colorSpace: colorSpace) else {
          throw ImageError.cantConvertToPng
      }
      return pngData
  }

}
</code></pre>

<ul>
<li>This takes the NSImage and converts it to a CGImage, first checking that the appropriate color space exists.</li>
<li>Then it uses the Core Graphics CGImage to create a Core Image CIImage.</li>
<li>There is a new API in macOS 10.13 to extract the png data from a CIImage while assigning a color profile.</li>
<li>This Data can then be written directly to a file and there you have a PNG with an attached color profile.</li>
</ul>

<h2 id="transparency">Transparency</h2>

<p>Now problems 1 &amp; 2 have been solved. Problem 3 was the most difficult. It turned out to be a two-part problem because an image file can have no transparent pixels but still have an alpha channel in the file data.</p>

<p>At first, I thought maybe I could just circumvent the whole problem by converting the images to JPEGs which have no transparency or alpha channel. Using the code above, I just changed it to getting the <code>jpegRepresentation</code> instead and saving with a .jpg file extension.</p>

<p>While this solved the alpha channel problem, the transparent parts of the icon just went black which was a not a good look.</p>

<p><img src="/images/Transparent-Jpeg.png" alt="Transparent image converted to JPEG" /></p>

<p><em>For anyone horrified at my use of force-unwrapping, I never do this in a production app but in a playground, it makes the code shorter and it doesn&rsquo;t really matter if I get a crash there.</em></p>

<h3 id="converting-transparent-pixels-to-white">Converting transparent pixels to white</h3>

<p>So the first step must be to set the transparent parts of the image to another color. Searching for solutions online, most of the ones I came up with were very slow (processing each pixel) or so complicated that I didn&rsquo;t understand them, and I hate just copy-pasting code that I don&rsquo;t understand at all.</p>

<p>But eventually I found something that I morphed into this:</p>

<pre><code class="language-swift">extension NSImage {

    func makeAlphaWhite() -&gt; NSImage {
        guard let imageData = self.tiffRepresentation,
            let imageRep = NSBitmapImageRep(data: imageData),
            let jpegData = imageRep.representation(using: .jpeg, properties: [
                NSBitmapImageRep.PropertyKey.compressionFactor: NSNumber(value: 1.0)
                ]),
            let jpegImage = NSImage(data: jpegData) else {
                return image
        }
        return jpegImage
    }

}
</code></pre>

<p>It used basically the same trick of converting the image into a JPEG but doing it this way via <code>NSBitmapImageRep</code> turned the transparent pixels white instead of black. And as you can see, this gave a much better looking image:</p>

<p><img src="/images/MakeAlphaWhite.png" alt="Transparent portions converted to white" /></p>

<p>Now I was able to continue with my plans to have JPEGs rule the world! This worked really well in my early tests but then I came to try a Stickers app and the icons didn’t work. I couldn&rsquo;t even drag them in manually! Back to the Apple docs and I see that icons must be PNGs.</p>

<p>When I changed the transparent pixels to white, added the color space and then saved the PNG data, I got an image that looked correct but the file still contained an alpha channel. So I had to come up with a method that re-wrote the PNG data in such a way that it never contained any alpha data at all.</p>

<h3 id="removing-the-alpha-channel">Removing the alpha channel</h3>

<p>Graphics experts are probably groaning aloud by now, but I did eventually arrive at a solution, however hacky:</p>

<pre><code class="language-swift">extension NSImage {

    func convertImageTo_sRGB_noAlpha() throws -&gt; Data {
        guard let colorSpace = CGColorSpace(name: CGColorSpace.sRGB),
            let cgi = self.cgImage(forProposedRect: nil,
                                   context: nil,
                                   hints: nil) else {
                                    throw ImageError.cantMakeCgImage
        }

        let ci = CIImage(cgImage: cgi)
        guard let jpgData = CIContext().jpegRepresentation(of: ci,
                                                           colorSpace: colorSpace) else {
            throw ImageError.cantConvertToJpg
        }
        guard let jpegImage = NSImage(data: jpgData) else {
            throw ImageError.cantConvertToJpgImage
        }
        let pngData = try jpegImage.convertImageTo_sRGB()
        return pngData
    }

}
</code></pre>

<ul>
<li>Take the image <strong>after</strong> changing the transparent pixels to white.</li>
<li>Convert it to JPEG data with the required color space.</li>
<li>Convert the JPEG data back to an image - this will contain <strong>NO</strong> alpha data.</li>
<li>Use the original routine to convert this JPEG into PNG data with the correct color space.</li>
</ul>

<p>Running this in the playground looks like this:
<img src="/images/TransparentPng.png" alt="Creating non-transparent PNG in playground" /></p>

<p>And as you can see from the file info, it results in a file with the correctly assigned color profile and no alpha channel:</p>

<p><img src="/images/FileInfo.png" alt="Final result file info" /></p>

<p>The double shuffle sounds time-consuming and in-efficient but it really doesn&rsquo;t take long. In my tests, by far the longest part of creating an icon set is opening the file dialog.</p>

<h2 id="future-plans">Future plans</h2>

<ul>
<li>Add more unit tests.</li>
<li>Work out how to replace the transparent pixels with a selected color.</li>
<li>Offer better cropping and image positioning options.</li>
</ul>

<h2 id="references">References</h2>

<p>For resizing and cropping images, I use <a href="https://mattgemmell.com/imagecrop-source-code/">Matt Gemmell&rsquo;s NSImage+MGCropExtensions</a> and for further reading, I recommend Apple&rsquo;s Human Interface Guidelines concerning app icons for <a href="https://developer.apple.com/ios/human-interface-guidelines/icons-and-images/app-icon/">iOS</a> and <a href="https://developer.apple.com/macos/human-interface-guidelines/icons-and-images/app-icon/">macOS</a>.</p>

<blockquote>
<p>Note: here is Australia we use the spelling <strong>colour</strong> but for consistency with the code samples, I have used <strong>color</strong> throughout the text.</p>
</blockquote>
  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <a class="btn next" href="https://troz.net/post/2018/swiftlint/">← Consistent Swift Style</a>
      
      
      <a class="btn previous" href="https://troz.net/ncss2018/">NCSS 2018 →</a>
      
    </div>
  </div>
  
</div>

  </div>

  
    <link rel="stylesheet" href="/css/footer.css">

<footer class="footer">
  <div class="footer__inner">
    <div class="social_footer">
      <a id="email-Link" class="mailtoui" href="mailto:sarah@troz.net"><img src="/icons/envelope.svg" /></a>
      <a href="https://stackoverflow.com/users/1082632"><img src="/icons/stack-overflow.svg" /></a>
      <a href="https://twitter.com/trozware"><img src="/icons/twitter.svg" /></a>
      <a href="https://github.com/trozware"><img src="/icons/github.svg" /></a>
      <a href="https://troz.net/index.xml"><img src="/icons/rss.svg" /></a>
      <a href="https://troz.net//feed.json"><img src="/icons/json.png" /></a>
    </div>
  </div>

  <div class="footer__inner">
    <div class="copyright">
      
      <span>© 2012 - 2019 Sarah Reichelt</span>
      
      <span><a href="http://gohugo.io">Hugo</a> theme created by <a href="https://twitter.com/panr">panr</a> 2018</span>
    </div>
  </div>
</footer>


  <script src="/assets/main.js"></script>

  <script src="/assets/prism.js"></script>


<script src="https://cdn.jsdelivr.net/npm/mailtoui@latest/dist/mailtoui-min.js"></script>
  
</div>

</body>
</html>
